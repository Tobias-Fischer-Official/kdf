(function(){var b=window.Microsoft.WindowsLive.Chat.ChatSystem,a=window.Microsoft.WindowsLive.Chat.MessagingActivity;Chat.InputAreaController=function(){this.initComponent();this._createTextAreaControlPromise=null;this._textAreaControl=null;this._typingTracker=null;this._currentContextId=0;this._bindings=null;this._emojiOpen=false;this._selectedChatHandle=null;this._onContextMenu=this._onContextMenu.bind(this)};Jx.augment(Chat.InputAreaController,Jx.Component);Chat.InputAreaController.prototype._INPUT_WHOLEAREA_ID="chat-inputArea";Chat.InputAreaController.prototype._INPUT_TEXTAREA_ID="input-textarea-control";Chat.InputAreaController.prototype._INPUT_CONTAINER_ID="input-canvas-container";Chat.InputAreaController.prototype._STORAGE_KEY_PREFIX="input_";Chat.InputAreaController.prototype._EMOJI_BUTTON_ID="input-emojiPickerButton";Chat.InputAreaController.prototype._KEYCODE_ENTER=13;Chat.InputAreaController.prototype._KEYCODE_SPACE=32;Chat.InputAreaController.prototype._KEYCODE_FIRST_ALPHANUMERIC=48;Chat.InputAreaController.prototype._canvasDiv=null;Chat.InputAreaController.prototype._canvasContainerDiv=null;Chat.InputAreaController.prototype._createTextAreaControlPromise=null;Chat.InputAreaController.prototype._emojiPicker=null;Chat.InputAreaController.prototype._emojiPickerButton=null;Chat.InputAreaController.prototype._isInputControlEnabled=false;Chat.InputAreaController.prototype._delayShowingEmojiPicker=false;Chat.InputAreaController.prototype._OSKShown=false;Chat.InputAreaController.prototype._setFocus=false;Chat.InputAreaController.prototype.getUI=function(a){a.html="    <div id='chat-inputArea' class='chat-inputArea'>         <div id='input-canvas-container' class='input-main-normal' role='textbox'>           <div id='input-textarea-control'></div> <!-- canvas control will take this div -->         </div>         <div id='input-emojiPickerButton' class='input-emojiPickerButton' role='button' tabindex='0'></div>     </div>"};Chat.InputAreaController.prototype.activateUI=function(){Jx.log.perf("inputAreaController_activateUI_Start");this.on(Chat.Events.mainUiReady,this._onMainUiReady);this._canvasDiv=document.getElementById(this._INPUT_TEXTAREA_ID);this._canvasDiv.setAttribute("aria-label",Jx.res.getString("chatInputControlAriaLabel"));this._canvasDiv.setAttribute("aria-describedby",Jx.res.getString("chatInputControlAriaLabel"));var a=Chat.EmoticonManager.getInstance();this._createTextAreaControlPromise=ModernCanvas.createCanvasAsync(this._canvasDiv,{className:"chat",autoReplaceManager:a}).then(function(a){this._textAreaControl=a}.bind(this));Jx.log.perf("inputAreaController_activateUI_Stop")};Chat.InputAreaController.prototype._onMainUiReady=function(){this._createTextAreaControlPromise.done(function(){Jx.log.perf("inputAreaController_mainUiReady_Start");this._canvasContainerDiv=document.getElementById(this._INPUT_CONTAINER_ID);this._emojiPickerButton=document.getElementById(this._EMOJI_BUTTON_ID);this._emojiPickerButton.innerText="\ue170";this._emojiPickerButton.setAttribute("aria-label",Jx.res.getString("chatInputEmojiAria"));this._emojiPickerButton.setAttribute("aria-describedby",Jx.res.getString("chatInputEmojiAria"));this._hookEvents();this._typingTracker=new Chat.TypingTracker;this.append(this._typingTracker);this._typingTracker.initTracker(this._textAreaControl);this._onSelectedChatChanged();Jx.log.perf("inputAreaController_mainUiReady_Stop")}.bind(this))};Chat.InputAreaController.prototype.deactivateUI=function(){Jx.log.perf("inputAreaController_deactivateUI_Start");this.detach(Chat.Events.mainUiReady,this._onMainUiReady);this._unhookEvents();this._prepareClosing();this._typingTracker.releaseTracker();this._typingTracker=null;this._textAreaControl.dispose();this._textAreaControl=null;this._currentContextId=0;this._canvasDiv=null;this._canvasContainerDiv=null;this._emojiPicker=null;this._emojiPickerButton=null;Jx.log.perf("inputAreaController_deactivateUI_Stop")};Chat.InputAreaController.prototype._hookEvents=function(){var a=Chat.kbEvents.getEventName(Jx.KeyCode.e,{ctrlKey:true});this._bindings=Chat.binder.attach(this,[{on:"keydown",from:this._textAreaControl,then:this._onTextAreaKeyDown},{on:"focus",from:this._textAreaControl,then:this._onFocused},{on:"blur",from:this._textAreaControl,then:this._onBlur},{on:Chat.Events.selectedChatChanged,then:this._onSelectedChatChanged},{on:Chat.Events.userMessageTyped,then:this._onUserMessageTyped},{on:Chat.Events.suspend,then:this._prepareClosing},{on:Chat.Events.appBarBeforeShow,then:this._onBeforeAppBarShow},{on:Chat.Events.appBarBeforeHide,then:this._onBeforeAppBarHide},{on:Chat.Events.beforeDeleteSelectedChat,then:this._beforeDeleteSelectedChat},{on:"click",from:this._emojiPickerButton,then:this._showEmojiPicker},{on:"keydown",from:this._emojiPickerButton,then:this._onEmojiPickerButtonKeyDown},{on:a,from:Chat.kbEvents,then:Chat.KBMouseEvents.preventDefaultCallback(this._toggleEmojiPicker)},{on:Chat.Events.afterKeyboardDown,then:this._onInputPaneAfterHide},{on:Chat.Events.afterKeyboardUp,then:this._onInputPaneAfterShow},{on:Chat.Events.enterContentAnimationChatAreaStarting,then:this._onAnimationStarting},{on:Chat.Events.enterContentAnimationChatAreaCompleted,then:this._onAnimationCompleted},{on:Chat.Events.currentTransportChanged,then:this._updateControl},{on:Chat.Events.inputFocusRequested,then:this._focusRequested}]);this._textAreaControl.addEventListener("contextmenu",this._onContextMenu,true)};Chat.InputAreaController.prototype._unhookEvents=function(){Chat.binder.detach(this._bindings);this._textAreaControl.removeEventListener("contextmenu",this._onContextMenu,true)};Chat.InputAreaController.prototype._onTextAreaKeyDown=function(a){if(a.keyCode===this._KEYCODE_ENTER&&!a.shiftKey&&!a.ctrlKey)if(this._canSend()){Jx.log.perf("inputAreaController_sendMessage");a.preventDefault();var b=this._getUserTypedMessage();if(b.length>0){this._sendNewMessage(b,this._isUserTypingRTL());this._reset();Jx.EventManager.broadcast(Chat.Events.messageSent,[],this.getParent())}}else Jx.EventManager.broadcast(Chat.Events.cannotSend)};Chat.InputAreaController.prototype._onFocused=function(){Jx.addClass(this._canvasContainerDiv,"input-main-active")};Chat.InputAreaController.prototype._onBlur=function(){Jx.removeClass(this._canvasContainerDiv,"input-main-active")};Chat.InputAreaController.prototype._getIsReadOnlyChat=function(){return Chat.Toolbox.selectedChat.isReadOnly};Chat.InputAreaController.prototype._canSend=function(){var a=false;if(Chat.Toolbox.selectedIMActivity)a=Chat.Toolbox.selectedIMActivity.canSend;return a};Chat.InputAreaController.prototype._sendNewMessage=function(d,c){if(Chat.Toolbox.selectedIMActivity){var b=new a.IMTextMessage(Chat.Toolbox.selectedIMActivity,d);b.formatRTL=c;Chat.Toolbox.selectedIMActivity.send(b)}};Chat.InputAreaController.prototype._sendNewTypingIndicator=function(){Chat.Toolbox.selectedIMActivity&&Chat.Toolbox.selectedIMActivity.markSenderTyping()};Chat.InputAreaController.prototype._putFocusOnInputControl=function(){window.msSetImmediate(function(){this._isInputControlEnabled&&this._textAreaControl.focus()}.bind(this))};Chat.InputAreaController.prototype._focusRequested=function(){this._setFocus=true};Chat.InputAreaController.prototype._onSelectedChatChanged=function(){Jx.log.perf("inputAreaController_selectedChatChanged_Start");Boolean(this._emojiPicker)&&this._emojiPicker.hide();this._saveCurrentUnsentMessage();this._reset();this._currentContextId=0;window.clearImmediate(this._selectedChatHandle);this._selectedChatHandle=msSetImmediate(function(){if(Boolean(Chat.Toolbox.selectedChatContext))this._currentContextId=Chat.Toolbox.selectedChatContext.id;this._updateControl()}.bind(this));Jx.log.perf("inputAreaController_selectedChatChanged_Stop")};Chat.InputAreaController.prototype._updateControl=function(){var a=Boolean(Chat.Toolbox.selectedChatContext),b=a&&this._getIsReadOnlyChat();if(a&&!b&&this._isNonBlockedUser()){this._setControlEnabled(true,Jx.res.getString("chatInputControlCueText"));this._loadCurrentUnsentMessage();this